<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gnosis Chain Batch Test</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; }
    label, input, button { display: block; margin-bottom: 0.5rem; }
    #status { margin-top: 1rem; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Batch Transaction Test</h1>
  <button id="connect">Connect Wallet</button>
  <div id="wallet-address"></div>
  <div id="wallet-balance"></div>
  <div id="network-info"></div>
  <button id="switch-network" style="display: none; background-color: orange;">Switch to Gnosis Chain</button>
  <label for="recipient">Recipient Address:</label>
  <input id="recipient" placeholder="0xRecipientAddress" />
  <label for="amount">Amount (xDAI):</label>
  <input id="amount" type="number" step="0.0001" placeholder="0.01" />
  <button id="send">Send</button>
  <div id="status"></div>
  <!-- Moved Ethers script here, before custom script -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" integrity="" crossorigin="anonymous"></script>
  <script>
    // Check if ethers is loaded
    console.log('typeof ethers:', typeof ethers); 

    let provider, signer;
    const connectButton = document.getElementById('connect');
    const sendButton = document.getElementById('send');
    const statusDiv = document.getElementById('status');
    const walletAddressDiv = document.getElementById('wallet-address');
    const walletBalanceDiv = document.getElementById('wallet-balance');
    const networkInfoDiv = document.getElementById('network-info');
    const switchNetworkButton = document.getElementById('switch-network');

    async function updateConnectionInfo() {
      try {
        const address = await signer.getAddress();
        walletAddressDiv.innerText = 'Connected: ' + address;

        // Fetch and display network info
        const network = await provider.getNetwork();
        networkInfoDiv.innerText = `Network: ${network.name} (Chain ID: ${network.chainId})`;
        if (network.chainId !== 100) {
          networkInfoDiv.style.color = 'red';
          networkInfoDiv.innerText += ' - WRONG NETWORK!';
          switchNetworkButton.style.display = 'block';
        } else {
          networkInfoDiv.style.color = 'green';
          switchNetworkButton.style.display = 'none';
        }

        // Fetch and display balance
        const balanceBigNum = await signer.getBalance();
        const balanceFormatted = ethers.utils.formatEther(balanceBigNum);
        walletBalanceDiv.innerText = `Balance: ${parseFloat(balanceFormatted).toFixed(4)} xDAI`;

        statusDiv.innerText = '';

      } catch (infoError) {
        console.error("Error updating connection info:", infoError);
        statusDiv.innerText = 'Error updating info: ' + infoError.message;
        walletAddressDiv.innerText = '';
        walletBalanceDiv.innerText = '';
        networkInfoDiv.innerText = '';
        switchNetworkButton.style.display = 'none';
      }
    }

    connectButton.onclick = async () => {
      if (typeof ethers === 'undefined') {
         statusDiv.innerText = 'Error: Ethers library not loaded!';
         console.error('Ethers library failed to load.');
         return; 
      }

      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          await updateConnectionInfo();

          // Reload the page if the network changes
          if (window.ethereum && window.ethereum.on) {
            window.ethereum.on('chainChanged', (_chainId) => window.location.reload());
            window.ethereum.on('accountsChanged', (_accounts) => window.location.reload()); // Also reload if account changes
          }

        } catch (err) {
          statusDiv.innerText = 'Connection error: ' + err.message;
          walletAddressDiv.innerText = '';
          walletBalanceDiv.innerText = '';
          networkInfoDiv.innerText = '';
          switchNetworkButton.style.display = 'none';
        }
      } else {
        statusDiv.innerText = 'Please install MetaMask or another Web3 wallet.';
      }
    };

    switchNetworkButton.onclick = async () => {
      if (!provider) {
        statusDiv.innerText = 'Connect wallet first.';
        return;
      }
      try {
        await provider.send('wallet_switchEthereumChain', [{ chainId: '0x64' }]); // 0x64 = 100 (Gnosis)
        // Page reload will handle this now
      } catch (switchError) {
        console.error("Failed to switch network:", switchError);
        statusDiv.innerText = 'Failed to switch network: ' + (switchError.message || 'User rejected request?');
      }
    };

    sendButton.onclick = async () => {
      if (typeof ethers === 'undefined') {
         statusDiv.innerText = 'Error: Ethers library not loaded!';
         console.error('Ethers library failed to load.');
         return; 
      }
      if (!signer) {
        statusDiv.innerText = 'Connect wallet first.';
        return;
      }
      const to = document.getElementById('recipient').value;
      const amount = document.getElementById('amount').value;
      try {
        statusDiv.innerText = 'Sending transaction...';
        const tx = await signer.sendTransaction({
          to,
          value: ethers.utils.parseEther(amount)
        });
        statusDiv.innerText = 'Transaction sent: ' + tx.hash;
        await tx.wait();
        statusDiv.innerText = 'Transaction confirmed: ' + tx.hash;
      } catch (err) {
        statusDiv.innerText = 'Error: ' + err.message;
      }
    };
  </script>
</body>
</html>
