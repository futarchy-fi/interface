<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèõÔ∏è Futarchy SDK - Complete Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 1rem;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            padding: 2rem;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }
        
        .section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #555;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }
        
        .status-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .status-value {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .connected { color: #28a745; }
        .disconnected { color: #dc3545; }
        .approved { color: #28a745; }
        .not-approved { color: #ffc107; }
        
        .merge-config {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .token-status {
            display: grid;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .token-info {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .approval-status {
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .approval-status {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .approval-approved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .approval-not-approved {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .approval-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .log-section {
            grid-column: 1 / -1;
            margin-top: 1rem;
        }
        
        .log {
            background: #1a1a1a;
            color: #00ff41;
            font-family: 'Monaco', monospace;
            font-size: 0.8rem;
            padding: 1rem;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .contracts {
            grid-column: 1 / -1;
            font-size: 0.8rem;
            color: #666;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }
        
        .contract-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .contract-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .contract-address {
            font-family: 'Monaco', monospace;
            color: #333;
            font-size: 0.75rem;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Futarchy SDK</h1>
            <p>Complete Prediction Market Operations + Swap Cartridges on Gnosis Chain</p>
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 0.9rem;">
                <strong>üß™ Real Testing Steps:</strong><br>
                1. Connect wallet (MetaMask) ‚Üí 2. Check approval status ‚Üí 3. Approve if needed ‚Üí 4. Enter amount ‚Üí 5. Split position or swap tokens!<br>
                <strong>Proposal:</strong> 0xDA36a35CA4Fe6214C37a452159C0C9EAd45D5919 | <strong>Collateral:</strong> sDAI<br>
                <strong>üîÑ New:</strong> CoW Swap + Swapr V3 Algebra cartridges for sDAI ‚Üî wxDAI swaps<br>
                <strong>üéØ Latest:</strong> Split + Swap operation - automatically split SDAI to get YES tokens, then swap to target token!<br>
                <strong>üèÜ Newest:</strong> Redeem Outcomes operation - redeem winning outcome tokens after proposal resolution!<br>
                <strong>üìä Fresh:</strong> Futarchy Data Fetcher - live market data, balances, positions & mergeable amounts (10s polling)!<br>
                <strong>üèõÔ∏è Latest:</strong> Market Discovery - browse all available futarchy markets from database & auto-populate forms!
            </div>
        </div>
        
        <div class="main-content">
            <!-- Connection & Status Section -->
            <div class="section">
                <h3>üîó Connection Status</h3>
                <div class="status-grid">
                    <div class="status-card">
                        <div class="status-label">Wallet</div>
                        <div class="status-value disconnected" id="wallet-status">Not connected</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Network</div>
                        <div class="status-value" id="network-status">Gnosis Chain</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Collateral Balance</div>
                        <div class="status-value" id="balance-status">-</div>
                    </div>
                    <div class="status-card">
                        <div class="status-label">Approval Status</div>
                        <div class="status-value" id="approval-status">-</div>
                    </div>
                </div>
                
                <button class="btn btn-primary full-width" id="connect-btn">Connect Wallet</button>
            </div>
            
            <!-- Configuration Section -->
            <div class="section">
                <h3>‚öôÔ∏è Configuration</h3>
                
                <div class="form-group">
                    <label for="proposal-address">Proposal Address</label>
                    <input type="text" id="proposal-address" placeholder="0x..." value="0xDA36a35CA4Fe6214C37a452159C0C9EAd45D5919">
                </div>
                
                <div class="form-group">
                    <label for="collateral-token">Collateral Token</label>
                    <select id="collateral-token">
                        <option value="0xaf204776c7245bF4147c2612BF6e5972Ee483701">sDAI</option>
                        <option value="0x6B175474E89094C44Da98b954EedeAC495271d0F">DAI</option>
                        <option value="0xA0b86a33E6441d59F8a87EC9e2a71E8e9f8E1222">USDC</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="operation-amount">Amount (sDAI)</label>
                    <input type="number" id="operation-amount" value="1" min="0" step="0.1" placeholder="Start with 1 sDAI for testing">
                </div>
                
                <div id="approval-check-result"></div>
                
                <button class="btn btn-info full-width" id="check-approval-btn" disabled>Check Approval Status</button>
            </div>
            
            <!-- Approval Section -->
            <div class="section">
                <h3>‚úÖ Token Approval</h3>
                
                <div class="form-group">
                    <label for="approval-amount">Approval Amount</label>
                    <select id="approval-amount">
                        <option value="max">Unlimited Approval</option>
                        <option value="1000">1,000 tokens</option>
                        <option value="10000">10,000 tokens</option>
                        <option value="custom">Custom amount</option>
                    </select>
                </div>
                
                <div class="form-group" id="custom-approval-group" style="display: none;">
                    <label for="custom-approval-amount">Custom Amount</label>
                    <input type="number" id="custom-approval-amount" value="1000" min="0" step="0.1">
                </div>
                
                <button class="btn btn-warning full-width" id="approve-btn" disabled>Approve Collateral</button>
            </div>
            
            <!-- Futarchy Operations Section -->
            <div class="section">
                <h3>üéØ Futarchy Operations</h3>
                
                <div class="btn-grid">
                    <button class="btn btn-success" id="split-btn" disabled>Split Position</button>
                    <button class="btn btn-info" id="merge-btn" disabled>Merge Positions</button>
                    <button class="btn btn-primary" id="redeem-positions-btn" disabled>Redeem Positions</button>
                    <button class="btn btn-secondary" id="redeem-proposal-btn" disabled>Redeem Proposal</button>
                </div>
                
                <!-- Complete Operation Buttons -->
                <div style="margin: 1.5rem 0; padding: 1rem; background: #e8f5e8; border-radius: 8px; border: 2px solid #28a745;">
                    <h4 style="margin: 0 0 1rem 0; color: #155724;">üöÄ One-Click Complete Operations</h4>
                    <div class="btn-grid">
                        <button class="btn btn-success" id="complete-split-btn" disabled style="font-weight: bold;">‚ö° Complete Split</button>
                        <button class="btn btn-info" id="complete-merge-btn" disabled style="font-weight: bold;">‚ö° Complete Merge</button>
                    </div>
                    <small style="color: #155724; font-style: italic;">
                        These buttons automatically handle approval checks ‚Üí approve if needed ‚Üí execute operation
                    </small>
                </div>

                <!-- Split + Swap Operation -->
                <div style="margin: 1.5rem 0; padding: 1rem; background: #fff3cd; border-radius: 8px; border: 2px solid #ffc107;">
                    <h4 style="margin: 0 0 1rem 0; color: #856404;">üéØ Split + Swap Operation</h4>
                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #856404;">
                        Automatically split SDAI to get enough YES SDAI, then swap to YES GNO
                    </p>
                    
                    <div class="form-group">
                        <label for="yes-sdai-token">YES SDAI Token Address</label>
                        <input type="text" id="yes-sdai-token" placeholder="0x... (YES SDAI token address)" value="">
                    </div>
                    
                    <div class="form-group">
                        <label for="yes-gno-token">YES GNO Token Address</label>
                        <input type="text" id="yes-gno-token" placeholder="0x... (YES GNO token address)" value="">
                    </div>
                    
                    <div class="form-group">
                        <label for="target-amount">Target YES SDAI Amount</label>
                        <input type="number" id="target-amount" value="2" min="0" step="0.1" placeholder="Amount of YES SDAI to trade">
                    </div>
                    
                    <div class="form-group">
                        <label for="swap-slippage">Swap Slippage (basis points)</label>
                        <input type="number" id="swap-slippage" value="100" min="0" step="10" placeholder="100 = 1% slippage">
                    </div>
                    
                    <button class="btn btn-warning full-width" id="complete-split-swap-btn" disabled style="font-weight: bold;">
                        ‚ö° Complete Split + Swap
                    </button>
                    
                    <small style="color: #856404; font-style: italic; display: block; margin-top: 0.5rem;">
                        Example: Have 0.5 YES SDAI, want 2.0 ‚Üí splits 1.5 SDAI ‚Üí swaps all 2.0 YES SDAI for YES GNO
                    </small>
                </div>

                <!-- Redeem Outcome Tokens Operation -->
                <div style="margin: 1.5rem 0; padding: 1rem; background: #d1ecf1; border-radius: 8px; border: 2px solid #17a2b8;">
                    <h4 style="margin: 0 0 1rem 0; color: #0c5460;">üéØ Redeem Outcome Tokens</h4>
                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #0c5460;">
                        Redeem winning outcome tokens after proposal resolution (calls redeemProposal)
                    </p>
                    
                    <div class="form-group">
                        <label for="redeem-token1-address">Token 1 Address (e.g., YES_GNO)</label>
                        <input type="text" id="redeem-token1-address" placeholder="0x... (leave empty if amount1 is 0)" value="">
                    </div>
                    
                    <div class="form-group">
                        <label for="redeem-token2-address">Token 2 Address (e.g., YES_SDAI)</label>
                        <input type="text" id="redeem-token2-address" placeholder="0x... (leave empty if amount2 is 0)" value="">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="redeem-amount1">Amount 1 (Token 1)</label>
                            <input type="number" id="redeem-amount1" value="0" min="0" step="0.001" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="redeem-amount2">Amount 2 (Token 2)</label>
                            <input type="number" id="redeem-amount2" value="0" min="0" step="0.001" placeholder="0">
                        </div>
                    </div>
                    
                    <button class="btn btn-info full-width" id="complete-redeem-outcomes-btn" disabled style="font-weight: bold;">
                        üéØ Complete Redeem Outcomes
                    </button>
                    
                    <small style="color: #0c5460; font-style: italic; display: block; margin-top: 0.5rem;">
                        Note: Only approves tokens with amount > 0. At least one amount must be > 0.
                    </small>
                </div>

                <!-- Futarchy Data Fetcher -->
                <div style="margin: 1.5rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #6c757d;">
                    <h4 style="margin: 0 0 1rem 0; color: #495057;">üìä Futarchy Data Fetcher</h4>
                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #495057;">
                        Live futarchy proposal data (polls every 10 seconds)
                    </p>
                    
                    <div class="btn-grid">
                        <button class="btn btn-secondary" id="start-fetcher-btn" disabled style="font-weight: bold;">
                            ‚ñ∂Ô∏è Start Fetcher
                        </button>
                        <button class="btn btn-secondary" id="stop-fetcher-btn" disabled style="font-weight: bold;">
                            ‚è∏Ô∏è Stop Fetcher
                        </button>
                        <button class="btn btn-secondary" id="fetch-once-btn" disabled style="font-weight: bold;">
                            üîÑ Fetch Once
                        </button>
                    </div>
                    
                    <div id="fetcher-status" style="margin: 1rem 0; padding: 0.5rem; background: white; border-radius: 4px; font-family: Monaco, monospace; font-size: 0.8rem;">
                        Status: Not started
                    </div>
                    
                    <!-- Data Display -->
                    <div id="futarchy-data-display" style="margin: 1rem 0; padding: 1rem; background: white; border-radius: 8px; display: none;">
                        <h5 style="margin: 0 0 1rem 0; color: #495057;">üìà Live Data</h5>
                        
                        <!-- Market Info -->
                        <div id="market-info" style="margin-bottom: 1rem;">
                            <strong>Market:</strong> <span id="market-name">Loading...</span><br>
                            <strong>Proposal:</strong> <span id="proposal-address">Loading...</span>
                        </div>
                        
                        <!-- Token Addresses -->
                        <div id="token-addresses" style="margin-bottom: 1rem; font-family: Monaco, monospace; font-size: 0.8rem;">
                            <strong>Tokens:</strong><br>
                            <span style="color: #28a745;">Company (GNO):</span> <span id="company-token">-</span><br>
                            <span style="color: #17a2b8;">Currency (SDAI):</span> <span id="currency-token">-</span><br>
                            <span style="color: #fd7e14;">YES_GNO:</span> <span id="yes-company-token">-</span><br>
                            <span style="color: #6f42c1;">YES_SDAI:</span> <span id="yes-currency-token">-</span><br>
                            <span style="color: #dc3545;">NO_GNO:</span> <span id="no-company-token">-</span><br>
                            <span style="color: #ffc107;">NO_SDAI:</span> <span id="no-currency-token">-</span>
                        </div>
                        
                        <!-- User Balances (when connected) -->
                        <div id="user-balances" style="margin-bottom: 1rem; display: none;">
                            <strong>Your Balances:</strong><br>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-family: Monaco, monospace; font-size: 0.8rem;">
                                <div>YES_GNO: <span id="balance-yes-company">-</span></div>
                                <div>NO_GNO: <span id="balance-no-company">-</span></div>
                                <div>YES_SDAI: <span id="balance-yes-currency">-</span></div>
                                <div>NO_SDAI: <span id="balance-no-currency">-</span></div>
                                <div>GNO: <span id="balance-company">-</span></div>
                                <div>SDAI: <span id="balance-currency">-</span></div>
                            </div>
                        </div>
                        
                        <!-- Position Analysis -->
                        <div id="position-analysis" style="margin-bottom: 1rem; display: none;">
                            <strong>Position Analysis:</strong><br>
                            <div style="background: #e9f7ef; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                                <strong>Mergeable:</strong><br>
                                <span id="mergeable-company">-</span> company tokens<br>
                                <span id="mergeable-currency">-</span> currency tokens
                            </div>
                            <div style="background: #fff3cd; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                                <strong>Positions:</strong><br>
                                <span id="position-company">-</span><br>
                                <span id="position-currency">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Market Discovery Section -->
                <div style="margin: 1.5rem 0; padding: 1rem; background: #e3f2fd; border-radius: 8px; border: 2px solid #1976d2;">
                    <h4 style="margin: 0 0 1rem 0; color: #1565c0;">üèõÔ∏è Market Discovery</h4>
                    <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #1565c0;">
                        Browse all available futarchy markets from the database
                    </p>
                    
                    <!-- Supabase Configuration -->
                    <div id="supabase-config" style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.7); border-radius: 6px; border: 1px solid #90caf9;">
                        <h5 style="margin: 0 0 0.5rem 0; color: #1565c0;">‚öôÔ∏è Supabase Configuration</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="supabase-url" placeholder="Supabase URL" 
                                   value="https://nvhqdqtlsdboctqjcelq.supabase.co"
                                   style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem;">
                            <input type="password" id="supabase-key" placeholder="Supabase Anon Key" 
                                   style="padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem;">
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-primary" id="connect-supabase-btn" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">
                                üîó Connect
                            </button>
                            <span id="supabase-connection-status" style="font-size: 0.8rem; color: #666;">
                                Not connected
                            </span>
                        </div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 0.5rem;">
                            üí° Get your credentials from <a href="https://supabase.com/dashboard" target="_blank" style="color: #1976d2;">Supabase Dashboard</a> ‚Üí Settings ‚Üí API
                        </div>
                    </div>
                    
                    <div class="btn-grid" style="margin-bottom: 1rem;">
                        <button class="btn btn-primary" id="discover-markets-btn" disabled style="font-weight: bold;">
                            üîç Discover Markets
                        </button>
                        <button class="btn btn-secondary" id="filter-open-btn" disabled style="font-weight: bold;">
                            üîÑ Open Only
                        </button>
                        <button class="btn btn-secondary" id="filter-public-btn" disabled style="font-weight: bold;">
                            üëÅÔ∏è Public Only
                        </button>
                        <button class="btn btn-secondary" id="refresh-markets-btn" disabled style="font-weight: bold;">
                            üîÑ Refresh
                        </button>
                    </div>
                    
                    <div id="market-discovery-status" style="margin: 1rem 0; padding: 0.5rem; background: white; border-radius: 4px; font-family: Monaco, monospace; font-size: 0.8rem;">
                        Status: Ready to discover markets
                    </div>
                    
                    <!-- Markets List -->
                    <div id="markets-list" style="margin: 1rem 0; display: none;">
                        <h5 style="margin: 0 0 1rem 0; color: #1565c0;">üìã Available Markets</h5>
                        <div id="markets-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background: white;">
                            <!-- Markets will be populated here -->
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            üí° Click on any market to auto-populate the proposal address below
                        </div>
                    </div>
                </div>
            </div>

            <!-- Swap Operations Section -->
            <div class="section">
                <h3>üîÑ Swap Operations</h3>
                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
                    Example: Swap sDAI ‚Üí wxDAI on Gnosis Chain using CoW Protocol or Swapr V3
                </p>
                
                <div class="form-group">
                    <label for="swap-amount">Swap Amount (sDAI)</label>
                    <input type="number" id="swap-amount" value="1" min="0" step="0.1" placeholder="Amount to swap">
                </div>
                
                <!-- CoW Swap Section -->
                <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #6f42c1;">
                    <h4 style="margin: 0 0 1rem 0; color: #6f42c1;">üêÑ CoW Protocol</h4>
                    <div class="btn-grid">
                        <button class="btn" id="cow-check-approval-btn" disabled style="background: #6f42c1; color: white;">Check Approval</button>
                        <button class="btn" id="cow-approve-btn" disabled style="background: #6f42c1; color: white;">Approve sDAI</button>
                        <button class="btn" id="cow-swap-btn" disabled style="background: #6f42c1; color: white;">Swap via CoW</button>
                        <button class="btn" id="cow-complete-swap-btn" disabled style="background: #6f42c1; color: white; font-weight: bold;">‚ö° Complete CoW Swap</button>
                    </div>
                    <small style="color: #6f42c1; font-style: italic;">
                        CoW Protocol provides MEV protection and gasless trading
                    </small>
                </div>
                
                <!-- Swapr Algebra Section -->
                <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 2px solid #fd7e14;">
                    <h4 style="margin: 0 0 1rem 0; color: #fd7e14;">üîÑ Swapr V3 Algebra</h4>
                    <div class="btn-grid">
                        <button class="btn" id="swapr-check-approval-btn" disabled style="background: #fd7e14; color: white;">Check Approval</button>
                        <button class="btn" id="swapr-approve-btn" disabled style="background: #fd7e14; color: white;">Approve sDAI</button>
                        <button class="btn" id="swapr-swap-btn" disabled style="background: #fd7e14; color: white;">Swap via Swapr</button>
                        <button class="btn" id="swapr-complete-swap-btn" disabled style="background: #fd7e14; color: white; font-weight: bold;">‚ö° Complete Swapr Swap</button>
                    </div>
                    <small style="color: #fd7e14; font-style: italic;">
                        Swapr V3 uses Algebra pools with direct router execution (amountOutMinimum: 0)
                    </small>
                </div>
            </div>
                
                <!-- Merge Configuration -->
                <div class="merge-config" id="merge-config" style="display: none;">
                    <h4>üîÄ Merge YES + NO ‚Üí Collateral</h4>
                    <div class="form-group">
                        <label for="merge-amount">üí∞ Amount to Merge (YES + NO tokens)</label>
                        <input type="number" id="merge-amount" value="1" min="0" step="0.1" placeholder="Amount of YES/NO tokens to merge" style="font-size: 1.1rem; font-weight: bold; border: 2px solid #007bff;">
                        <small style="color: #007bff; font-weight: 600;">‚ö° This amount will be used for both complete and manual merge operations</small>
                    </div>
                    
                    <div class="token-status">
                        <div class="token-info">
                            <span>YES Token: </span>
                            <span class="contract-address" id="yes-token-display">0x9eA98D3F845c3b3bDb2310aA5c301505B61402C7</span>
                            <span id="yes-approval-status" class="approval-status">‚ùì Checking...</span>
                        </div>
                        <div class="token-info">
                            <span>NO Token: </span>
                            <span class="contract-address" id="no-token-display">0x24334A29A324ED40a08aaf035BbEdff374313145</span>
                            <span id="no-approval-status" class="approval-status">‚ùì Checking...</span>
                        </div>
                    </div>
                    
                    <div class="btn-grid">
                        <button class="btn btn-warning" id="approve-yes-btn" disabled>Approve YES</button>
                        <button class="btn btn-warning" id="approve-no-btn" disabled>Approve NO</button>
                        <button class="btn btn-info" id="check-merge-approvals-btn" disabled>Check Approvals</button>
                    </div>
                    
                    <button class="btn btn-success full-width" id="execute-merge-btn" disabled style="margin-top: 1rem;">üîÄ Execute Merge Transaction</button>
                </div>
                
                <div class="form-group">
                    <label for="condition-id">Condition ID (for winning outcomes)</label>
                    <input type="text" id="condition-id" placeholder="0x...">
                </div>
                
                <button class="btn btn-info full-width" id="get-outcomes-btn" disabled>Get Winning Outcomes</button>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar full-width">
                <div class="progress-fill" id="progress"></div>
            </div>
            
            <!-- Transaction Log -->
            <div class="section log-section">
                <h3>üìú Transaction Log</h3>
                <div class="log" id="log"></div>
            </div>
            
            <!-- Contract Addresses -->
            <div class="contracts">
                <h4>üìã Contract Addresses (Gnosis Chain)</h4>
                <div class="contract-grid">
                    <div class="contract-item">
                        <span>Futarchy Router:</span>
                        <span class="contract-address">0x7495a583ba85875d59407781b4958ED6e0E1228f</span>
                    </div>
                    <div class="contract-item">
                        <span>sDAI:</span>
                        <span class="contract-address">0xaf204776c7245bF4147c2612BF6e5972Ee483701</span>
                    </div>
                    <div class="contract-item">
                        <span>wxDAI:</span>
                        <span class="contract-address">0xe91D153E0b41518A2Ce8Dd3D7944Fa863463a97d</span>
                    </div>
                    <div class="contract-item">
                        <span>CoW Vault Relayer:</span>
                        <span class="contract-address">0xC92E8bdf79f0507f65a392b0ab4667716BFE0110</span>
                    </div>
                    <div class="contract-item">
                        <span>Swapr V3 Router:</span>
                        <span class="contract-address">0xffb643e73f280b97809a8b41f7232ab401a04ee1</span>
                    </div>
                    <div class="contract-item">
                        <span>Example YES Pool:</span>
                        <span class="contract-address">0xF336F812Db1ad142F22A9A4dd43D40e64B478361</span>
                    </div>
                    <div class="contract-item">
                        <span>Example NO Pool:</span>
                        <span class="contract-address">0xfbf1BE5CE2f9056dAaB1C368EC241ad7Be3507A8</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Add global polyfills for Node.js compatibility
        if (typeof global === 'undefined') {
            window.global = window.globalThis;
        }
        
        // Import required modules
        import { createWalletClient, createPublicClient, custom, http, parseEther, formatEther } from 'https://esm.sh/viem@1.19.0';
        import { gnosis } from 'https://esm.sh/viem@1.19.0/chains';
        
        // Import our SDK components
        import { DataLayer } from './DataLayer.js';
        import { createViemExecutor } from './executors/ViemExecutor.js';
        import { FutarchyCartridge } from './executors/FutarchyCartridge.js';
        import { CoWSwapCartridge } from './executors/CoWSwapCartridge.js';
        import { SwaprAlgebraCartridge } from './executors/SwaprAlgebraCartridge.js';
        import { createFutarchyFetcher } from './fetchers/FutarchyFetcher.js';
        import { createSupabasePoolFetcher } from './fetchers/SupabasePoolFetcher.js';

        // Contract addresses
        const CONTRACTS = {
            FUTARCHY_ROUTER: '0x7495a583ba85875d59407781b4958ED6e0E1228f',
            SDAI: '0xaf204776c7245bF4147c2612BF6e5972Ee483701',
            WXDAI: '0xe91D153E0b41518A2Ce8Dd3D7944Fa863463a97d', // Wrapped xDAI on Gnosis Chain
            REAL_PROPOSAL: '0xDA36a35CA4Fe6214C37a452159C0C9EAd45D5919',
            YES_TOKEN: '0x9eA98D3F845c3b3bDb2310aA5c301505B61402C7',
            NO_TOKEN: '0x24334A29A324ED40a08aaf035BbEdff374313145',
            // Swap Router Addresses
            COW_VAULT_RELAYER: '0xC92E8bdf79f0507f65a392b0ab4667716BFE0110',
            SWAPR_V3_ROUTER: '0xffb643e73f280b97809a8b41f7232ab401a04ee1'
        };

        // Simplified ABI for demo
        const ERC20_ABI = [
            {
                name: 'approve',
                type: 'function',
                stateMutability: 'nonpayable',
                inputs: [
                    { name: 'spender', type: 'address' },
                    { name: 'amount', type: 'uint256' }
                ],
                outputs: [{ name: '', type: 'bool' }]
            },
            {
                name: 'allowance',
                type: 'function',
                stateMutability: 'view',
                inputs: [
                    { name: 'owner', type: 'address' },
                    { name: 'spender', type: 'address' }
                ],
                outputs: [{ name: '', type: 'uint256' }]
            },
            {
                name: 'balanceOf',
                type: 'function',
                stateMutability: 'view',
                inputs: [{ name: 'account', type: 'address' }],
                outputs: [{ name: '', type: 'uint256' }]
            }
        ];

        const FUTARCHY_ABI = [
            {
                name: 'splitPosition',
                type: 'function',
                stateMutability: 'nonpayable',
                inputs: [
                    { name: 'proposal', type: 'address' },
                    { name: 'collateralToken', type: 'address' },
                    { name: 'amount', type: 'uint256' }
                ],
                outputs: []
            },
            {
                name: 'mergePositions',
                type: 'function',
                stateMutability: 'nonpayable',
                inputs: [
                    { name: 'proposal', type: 'address' },
                    { name: 'collateralToken', type: 'address' },
                    { name: 'amount', type: 'uint256' }
                ],
                outputs: []
            },
            {
                name: 'redeemPositions',
                type: 'function',
                stateMutability: 'nonpayable',
                inputs: [
                    { name: 'proposal', type: 'address' },
                    { name: 'collateralToken', type: 'address' },
                    { name: 'amount', type: 'uint256' }
                ],
                outputs: []
            }
        ];

        class FutarchyDemo {
            constructor() {
                this.dataLayer = null;
                this.executor = null;
                this.account = null;
                this.isConnected = false;
                this.approvalStatus = null;
                
                this.initializeElements();
                this.initializeSDK();
                this.attachEventListeners();
                
                this.log('üöÄ Futarchy SDK Demo initialized');
                this.log('üèóÔ∏è DataLayer ‚Üí ViemExecutor ‚Üí FutarchyCartridge ready');
                this.log('üìç Ready to connect wallet...');
            }
            
            initializeElements() {
                // Status elements
                this.walletStatus = document.getElementById('wallet-status');
                this.balanceStatus = document.getElementById('balance-status');
                this.approvalStatusEl = document.getElementById('approval-status');
                
                // Form elements
                this.proposalAddress = document.getElementById('proposal-address');
                this.collateralToken = document.getElementById('collateral-token');
                this.operationAmount = document.getElementById('operation-amount');
                this.approvalAmount = document.getElementById('approval-amount');
                this.customApprovalAmount = document.getElementById('custom-approval-amount');
                this.customApprovalGroup = document.getElementById('custom-approval-group');
                this.conditionId = document.getElementById('condition-id');
                
                // Buttons
                this.connectBtn = document.getElementById('connect-btn');
                this.checkApprovalBtn = document.getElementById('check-approval-btn');
                this.approveBtn = document.getElementById('approve-btn');
                this.splitBtn = document.getElementById('split-btn');
                this.mergeBtn = document.getElementById('merge-btn');
                this.redeemPositionsBtn = document.getElementById('redeem-positions-btn');
                this.redeemProposalBtn = document.getElementById('redeem-proposal-btn');
                this.getOutcomesBtn = document.getElementById('get-outcomes-btn');
                
                // Complete operation buttons
                this.completeSplitBtn = document.getElementById('complete-split-btn');
                this.completeMergeBtn = document.getElementById('complete-merge-btn');
                
                // Split + Swap operation elements
                this.yesSdaiToken = document.getElementById('yes-sdai-token');
                this.yesGnoToken = document.getElementById('yes-gno-token');
                this.targetAmount = document.getElementById('target-amount');
                this.swapSlippage = document.getElementById('swap-slippage');
                this.completeSplitSwapBtn = document.getElementById('complete-split-swap-btn');
                
                // Redeem Outcomes operation elements
                this.redeemToken1Address = document.getElementById('redeem-token1-address');
                this.redeemToken2Address = document.getElementById('redeem-token2-address');
                this.redeemAmount1 = document.getElementById('redeem-amount1');
                this.redeemAmount2 = document.getElementById('redeem-amount2');
                this.completeRedeemOutcomesBtn = document.getElementById('complete-redeem-outcomes-btn');
                
                // Futarchy Fetcher elements
                this.startFetcherBtn = document.getElementById('start-fetcher-btn');
                this.stopFetcherBtn = document.getElementById('stop-fetcher-btn');
                this.fetchOnceBtn = document.getElementById('fetch-once-btn');
                this.fetcherStatus = document.getElementById('fetcher-status');
                this.futarchyDataDisplay = document.getElementById('futarchy-data-display');
                
                // Data display elements
                this.marketName = document.getElementById('market-name');
                this.proposalAddressDisplay = document.getElementById('proposal-address');
                this.companyToken = document.getElementById('company-token');
                this.currencyToken = document.getElementById('currency-token');
                this.yesCompanyToken = document.getElementById('yes-company-token');
                this.yesCurrencyToken = document.getElementById('yes-currency-token');
                this.noCompanyToken = document.getElementById('no-company-token');
                this.noCurrencyToken = document.getElementById('no-currency-token');
                
                // Balance elements
                this.userBalances = document.getElementById('user-balances');
                this.balanceYesCompany = document.getElementById('balance-yes-company');
                this.balanceNoCompany = document.getElementById('balance-no-company');
                this.balanceYesCurrency = document.getElementById('balance-yes-currency');
                this.balanceNoCurrency = document.getElementById('balance-no-currency');
                this.balanceCompany = document.getElementById('balance-company');
                this.balanceCurrency = document.getElementById('balance-currency');
                
                // Position elements
                this.positionAnalysis = document.getElementById('position-analysis');
                this.mergeableCompany = document.getElementById('mergeable-company');
                this.mergeableCurrency = document.getElementById('mergeable-currency');
                this.positionCompany = document.getElementById('position-company');
                this.positionCurrency = document.getElementById('position-currency');
                
                // Market Discovery elements
                this.discoverMarketsBtn = document.getElementById('discover-markets-btn');
                this.filterOpenBtn = document.getElementById('filter-open-btn');
                this.filterPublicBtn = document.getElementById('filter-public-btn');
                this.refreshMarketsBtn = document.getElementById('refresh-markets-btn');
                this.marketDiscoveryStatus = document.getElementById('market-discovery-status');
                this.marketsList = document.getElementById('markets-list');
                this.marketsContainer = document.getElementById('markets-container');
                
                // Supabase Configuration elements
                this.supabaseUrl = document.getElementById('supabase-url');
                this.supabaseKey = document.getElementById('supabase-key');
                this.connectSupabaseBtn = document.getElementById('connect-supabase-btn');
                this.supabaseConnectionStatus = document.getElementById('supabase-connection-status');
                
                // Swap elements
                this.swapAmount = document.getElementById('swap-amount');
                
                // CoW Swap buttons
                this.cowCheckApprovalBtn = document.getElementById('cow-check-approval-btn');
                this.cowApproveBtn = document.getElementById('cow-approve-btn');
                this.cowSwapBtn = document.getElementById('cow-swap-btn');
                this.cowCompleteSwapBtn = document.getElementById('cow-complete-swap-btn');
                
                // Swapr buttons
                this.swaprCheckApprovalBtn = document.getElementById('swapr-check-approval-btn');
                this.swaprApproveBtn = document.getElementById('swapr-approve-btn');
                this.swaprSwapBtn = document.getElementById('swapr-swap-btn');
                this.swaprCompleteSwapBtn = document.getElementById('swapr-complete-swap-btn');
                
                // Merge operation elements
                this.mergeConfig = document.getElementById('merge-config');
                this.mergeAmount = document.getElementById('merge-amount');
                this.approveYesBtn = document.getElementById('approve-yes-btn');
                this.approveNoBtn = document.getElementById('approve-no-btn');
                this.checkMergeApprovalsBtn = document.getElementById('check-merge-approvals-btn');
                this.executeMergeBtn = document.getElementById('execute-merge-btn');
                this.yesApprovalStatus = document.getElementById('yes-approval-status');
                this.noApprovalStatus = document.getElementById('no-approval-status');
                
                // Other elements
                this.logElement = document.getElementById('log');
                this.progressBar = document.getElementById('progress');
                this.approvalCheckResult = document.getElementById('approval-check-result');
            }
            
            initializeSDK() {
                // Create DataLayer
                this.dataLayer = new DataLayer();
                
                // Create ViemExecutor
                this.executor = createViemExecutor({
                    rpcUrl: 'https://rpc.gnosischain.com'
                });
                
                // Create public client for fetcher
                this.publicClient = createPublicClient({
                    chain: gnosis,
                    transport: http('https://rpc.gnosischain.com')
                });
                
                // Register cartridges
                const futarchyCartridge = new FutarchyCartridge(CONTRACTS.FUTARCHY_ROUTER);
                const cowSwapCartridge = new CoWSwapCartridge();
                const swaprCartridge = new SwaprAlgebraCartridge();
                
                this.executor.registerCartridge(futarchyCartridge);
                this.executor.registerCartridge(cowSwapCartridge);
                this.executor.registerCartridge(swaprCartridge);
                
                // Register executor with DataLayer
                this.dataLayer.registerExecutor(this.executor);
                
                // Create and register Futarchy Fetcher
                this.futarchyFetcher = createFutarchyFetcher(this.publicClient);
                this.dataLayer.registerFetcher(this.futarchyFetcher);
                
                // Create and register Supabase Fetcher (for market discovery)
                this.hasMarketDiscovery = false;
                this.initializeSupabaseFetcher();
                
                // Initialize fetcher state
                this.fetcherInterval = null;
                this.fetcherRunning = false;
                this.currentMarkets = [];
                
                this.log('üåê Connected to Gnosis Chain RPC');
                this.log('üéØ FutarchyCartridge registered with DataLayer');
                this.log('üêÑ CoWSwapCartridge registered with DataLayer');
                this.log('üîÑ SwaprAlgebraCartridge registered with DataLayer');
                this.log('üìä FutarchyFetcher registered with DataLayer');
                this.log(`üìã Available operations: ${this.dataLayer.getAvailableOperations().length}`);
            }
            
            initializeSupabaseFetcher() {
                // Try to initialize with stored credentials
                const storedUrl = localStorage.getItem('supabase_url');
                const storedKey = localStorage.getItem('supabase_key');
                
                if (storedUrl && storedKey) {
                    this.supabaseUrl.value = storedUrl;
                    this.supabaseKey.value = storedKey;
                    this.connectSupabase(false); // Connect silently
                } else {
                    this.updateSupabaseStatus('Not connected - Enter credentials and click Connect');
                }
            }
            
            async connectSupabase(showLogs = true) {
                const url = this.supabaseUrl.value.trim();
                const key = this.supabaseKey.value.trim();
                
                if (!url || !key) {
                    this.updateSupabaseStatus('‚ùå Please enter both URL and API key');
                    if (showLogs) this.log('‚ö†Ô∏è Supabase URL and API key are required', 'error');
                    return;
                }
                
                this.updateSupabaseStatus('üîÑ Connecting...');
                if (showLogs) this.log('üîó Connecting to Supabase...');
                
                try {
                    // Create new Supabase fetcher
                    this.supabaseFetcher = createSupabasePoolFetcher(url, key);
                    
                    // Test the connection with a simple query
                    const testResult = await this.supabaseFetcher.fetch('markets.events', { limit: 1 });
                    
                    if (testResult.status === 'success') {
                        // Connection successful
                        if (this.hasMarketDiscovery && this.dataLayer.fetchers.some(f => f.name === 'SupabasePoolFetcher')) {
                            // Remove old fetcher
                            this.dataLayer.fetchers = this.dataLayer.fetchers.filter(f => f.name !== 'SupabasePoolFetcher');
                        }
                        
                        // Register new fetcher
                        this.dataLayer.registerFetcher(this.supabaseFetcher);
                        this.hasMarketDiscovery = true;
                        
                        // Store credentials for next time
                        localStorage.setItem('supabase_url', url);
                        localStorage.setItem('supabase_key', key);
                        
                        this.updateSupabaseStatus('‚úÖ Connected successfully');
                        this.enableMarketDiscoveryButtons();
                        
                        if (showLogs) {
                            this.log('‚úÖ Supabase connected successfully');
                            this.log('üìä Market discovery is now available');
                        }
                        
                    } else {
                        throw new Error(testResult.reason || 'Connection test failed');
                    }
                    
                } catch (error) {
                    this.hasMarketDiscovery = false;
                    this.updateSupabaseStatus(`‚ùå Connection failed: ${error.message}`);
                    this.disableMarketDiscoveryButtons();
                    
                    if (showLogs) {
                        this.log(`‚ùå Supabase connection failed: ${error.message}`, 'error');
                        this.log('üí° Check your URL and API key in the Supabase dashboard', 'info');
                    }
                }
            }
            
            updateSupabaseStatus(status) {
                this.supabaseConnectionStatus.textContent = status;
                
                // Update button state based on status
                if (status.includes('‚úÖ')) {
                    this.connectSupabaseBtn.textContent = 'üîó Connected';
                    this.connectSupabaseBtn.disabled = false;
                    this.connectSupabaseBtn.style.background = '#4caf50';
                } else if (status.includes('üîÑ')) {
                    this.connectSupabaseBtn.textContent = 'üîÑ Connecting...';
                    this.connectSupabaseBtn.disabled = true;
                } else {
                    this.connectSupabaseBtn.textContent = 'üîó Connect';
                    this.connectSupabaseBtn.disabled = false;
                    this.connectSupabaseBtn.style.background = '';
                }
            }
            
            enableMarketDiscoveryButtons() {
                this.discoverMarketsBtn.disabled = false;
                this.filterOpenBtn.disabled = false;
                this.filterPublicBtn.disabled = false;
                this.refreshMarketsBtn.disabled = false;
            }
            
            disableMarketDiscoveryButtons() {
                this.discoverMarketsBtn.disabled = true;
                this.filterOpenBtn.disabled = true;
                this.filterPublicBtn.disabled = true;
                this.refreshMarketsBtn.disabled = true;
            }
            
            attachEventListeners() {
                this.connectBtn.addEventListener('click', () => this.connectWallet());
                this.checkApprovalBtn.addEventListener('click', () => this.checkApproval());
                this.approveBtn.addEventListener('click', () => this.approveCollateral());
                
                // Futarchy operations
                this.splitBtn.addEventListener('click', () => this.splitPosition());
                this.mergeBtn.addEventListener('click', () => this.toggleMergeConfig());
                this.redeemPositionsBtn.addEventListener('click', () => this.redeemPositions());
                this.redeemProposalBtn.addEventListener('click', () => this.redeemProposal());
                this.getOutcomesBtn.addEventListener('click', () => this.getWinningOutcomes());
                
                // Complete operations 
                this.completeSplitBtn.addEventListener('click', () => this.completeSplit());
                this.completeMergeBtn.addEventListener('click', () => this.completeMerge());
                this.completeSplitSwapBtn.addEventListener('click', () => this.completeSplitSwap());
                this.completeRedeemOutcomesBtn.addEventListener('click', () => this.completeRedeemOutcomes());
                
                // Futarchy Fetcher event listeners
                this.startFetcherBtn.addEventListener('click', () => this.startFetcher());
                this.stopFetcherBtn.addEventListener('click', () => this.stopFetcher());
                this.fetchOnceBtn.addEventListener('click', () => this.fetchOnce());
                
                // Market Discovery event listeners
                this.discoverMarketsBtn.addEventListener('click', () => this.discoverMarkets());
                this.filterOpenBtn.addEventListener('click', () => this.filterMarkets('open'));
                this.filterPublicBtn.addEventListener('click', () => this.filterMarkets('public'));
                this.refreshMarketsBtn.addEventListener('click', () => this.refreshMarkets());
                
                // Supabase Configuration event listener
                this.connectSupabaseBtn.addEventListener('click', () => this.connectSupabase());
                
                // CoW Swap event listeners
                this.cowCheckApprovalBtn.addEventListener('click', () => this.cowCheckApproval());
                this.cowApproveBtn.addEventListener('click', () => this.cowApprove());
                this.cowSwapBtn.addEventListener('click', () => this.cowSwap());
                this.cowCompleteSwapBtn.addEventListener('click', () => this.cowCompleteSwap());
                
                // Swapr event listeners
                this.swaprCheckApprovalBtn.addEventListener('click', () => this.swaprCheckApproval());
                this.swaprApproveBtn.addEventListener('click', () => this.swaprApprove());
                this.swaprSwapBtn.addEventListener('click', () => this.swaprSwap());
                this.swaprCompleteSwapBtn.addEventListener('click', () => this.swaprCompleteSwap());
                
                // Merge operation event listeners
                this.approveYesBtn.addEventListener('click', () => this.approveYesToken());
                this.approveNoBtn.addEventListener('click', () => this.approveNoToken());
                this.checkMergeApprovalsBtn.addEventListener('click', () => this.checkMergeApprovals());
                this.executeMergeBtn.addEventListener('click', () => this.executeMerge());
                
                // Form handlers
                this.approvalAmount.addEventListener('change', () => this.toggleCustomApproval());
                this.collateralToken.addEventListener('change', () => this.updateBalanceAndApproval());
            }
            
            toggleCustomApproval() {
                const isCustom = this.approvalAmount.value === 'custom';
                this.customApprovalGroup.style.display = isCustom ? 'block' : 'none';
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
                const logMessage = `[${timestamp}] ${prefix} ${message}\n`;
                
                this.logElement.textContent += logMessage;
                this.logElement.scrollTop = this.logElement.scrollHeight;
            }
            
            updateProgress(percentage) {
                this.progressBar.style.width = `${percentage}%`;
            }
            
            enableFutarchyButtons() {
                const buttons = [
                    this.splitBtn, 
                    this.mergeBtn, 
                    this.redeemPositionsBtn, 
                    this.redeemProposalBtn, 
                    this.getOutcomesBtn,
                    this.completeSplitBtn,
                    this.completeMergeBtn,
                    this.completeSplitSwapBtn,
                    this.completeRedeemOutcomesBtn,
                    // Fetcher buttons
                    this.startFetcherBtn,
                    this.stopFetcherBtn,
                    this.fetchOnceBtn,
                    // Market Discovery buttons (enabled separately via Supabase connection)
                    // this.discoverMarketsBtn, this.filterOpenBtn, this.filterPublicBtn, this.refreshMarketsBtn,
                    // Swap buttons
                    this.cowCheckApprovalBtn,
                    this.cowApproveBtn,
                    this.cowSwapBtn,
                    this.cowCompleteSwapBtn,
                    this.swaprCheckApprovalBtn,
                    this.swaprApproveBtn,
                    this.swaprSwapBtn,
                    this.swaprCompleteSwapBtn
                ];
                buttons.forEach(btn => btn.disabled = false);
                
                // Also enable merge-related buttons if merge config is open
                if (this.mergeConfig && this.mergeConfig.style.display !== 'none') {
                    this.approveYesBtn.disabled = false;
                    this.approveNoBtn.disabled = false;
                    this.checkMergeApprovalsBtn.disabled = false;
                    this.executeMergeBtn.disabled = false;
                }
            }
            
            async connectWallet() {
                try {
                    this.connectBtn.disabled = true;
                    this.connectBtn.textContent = 'Connecting...';
                    this.updateProgress(25);
                    
                    this.log('üîó Using DataLayer to connect wallet...');
                    
                    // Use our DataLayer ‚Üí ViemExecutor system
                    for await (const status of this.dataLayer.execute('web3.connect')) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            this.updateProgress(50);
                        } else if (status.status === 'success') {
                            this.account = status.data.account;
                            this.isConnected = true;
                            
                            this.updateProgress(75);
                            
                            // Update UI
                            this.walletStatus.textContent = `${this.account.slice(0, 6)}...${this.account.slice(-4)}`;
                            this.walletStatus.className = 'status-value connected';
                            
                            this.connectBtn.textContent = 'Connected ‚úì';
                            this.checkApprovalBtn.disabled = false;
                            
                            this.updateProgress(100);
                            this.log(`‚úÖ Connected via DataLayer: ${this.account}`, 'success');
                            
                            // Check approval and enable buttons
                            await this.updateBalanceAndApproval();
                            this.enableFutarchyButtons();
                            
                            setTimeout(() => this.updateProgress(0), 1000);
                            break;
                            
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`Connection failed: ${error.message}`, 'error');
                    this.connectBtn.disabled = false;
                    this.connectBtn.textContent = 'Connect Wallet';
                    this.updateProgress(0);
                }
            }
            
            async ensureCorrectChain() {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const currentChainId = parseInt(chainId, 16);
                
                if (currentChainId !== 100) {
                    this.log('üîÑ Wrong chain detected. Switching to Gnosis Chain...');
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x64' }],
                        });
                        this.log('‚úÖ Switched to Gnosis Chain!', 'success');
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x64',
                                    chainName: 'Gnosis Chain',
                                    nativeCurrency: { name: 'XDAI', symbol: 'XDAI', decimals: 18 },
                                    rpcUrls: ['https://rpc.gnosischain.com'],
                                    blockExplorerUrls: ['https://gnosisscan.io/'],
                                }],
                            });
                            this.log('‚úÖ Gnosis Chain added and switched!', 'success');
                        } else {
                            throw switchError;
                        }
                    }
                } else {
                    this.log('‚úÖ Already on Gnosis Chain!', 'success');
                }
            }
            
            async updateBalanceAndApproval() {
                if (!this.account) return;
                
                try {
                    // Use our unified approval check which also gets balance
                    await this.checkApproval();
                    
                } catch (error) {
                    this.log(`Failed to update balance/approval: ${error.message}`, 'error');
                }
            }
            
            async checkApproval() {
                if (!this.account) return;
                
                try {
                    const tokenAddress = this.collateralToken.value;
                    
                    this.log('üîç Checking approval via DataLayer...');
                    
                    // Use our DataLayer ‚Üí FutarchyCartridge system
                    for await (const status of this.dataLayer.execute('futarchy.checkApproval', {
                        collateralToken: tokenAddress
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'success') {
                            const { isApproved, allowance, allowanceFormatted, balanceFormatted } = status.data;
                            this.approvalStatus = { isApproved, allowance };
                            
                            // Update UI
                            this.approvalStatusEl.textContent = isApproved ? 'Approved ‚úì' : 'Not Approved';
                            this.approvalStatusEl.className = `status-value ${isApproved ? 'approved' : 'not-approved'}`;
                            
                            // Update balance display
                            this.balanceStatus.textContent = `${parseFloat(balanceFormatted).toFixed(4)}`;
                            
                            const resultHtml = isApproved ? 
                                `<div class="approval-status approval-approved">‚úÖ Approved: ${allowanceFormatted} tokens</div>` :
                                `<div class="approval-status approval-not-approved">‚ö†Ô∏è Not approved. Please approve tokens first.</div>`;
                            
                            this.approvalCheckResult.innerHTML = resultHtml;
                            
                            this.approveBtn.disabled = isApproved;
                            this.approveBtn.textContent = isApproved ? 'Already Approved ‚úì' : 'Approve Collateral';
                            
                            this.log(`üìä Approval: ${isApproved ? 'Yes' : 'No'}, Balance: ${balanceFormatted}`, 'success');
                            break;
                            
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`Approval check failed: ${error.message}`, 'error');
                    this.approvalCheckResult.innerHTML = '<div class="approval-status approval-error">‚ùå Failed to check approval</div>';
                }
            }
            
            async approveCollateral() {
                if (!this.isConnected) return;
                
                try {
                    this.approveBtn.disabled = true;
                    this.approveBtn.textContent = 'Approving...';
                    this.updateProgress(20);
                    
                    const tokenAddress = this.collateralToken.value;
                    let amount = this.approvalAmount.value; // Use string values for our cartridge
                    
                    if (this.approvalAmount.value === 'custom') {
                        amount = this.customApprovalAmount.value;
                    }
                    
                    this.log(`üîÑ Approving ${amount === 'max' ? 'unlimited' : amount} tokens via DataLayer...`);
                    
                    // Use our DataLayer ‚Üí FutarchyCartridge system
                    for await (const status of this.dataLayer.execute('futarchy.approveCollateral', {
                        collateralToken: tokenAddress,
                        amount: amount
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            if (status.step === 'approve') {
                                this.updateProgress(40);
                            } else if (status.step === 'confirm') {
                                this.updateProgress(60);
                                if (status.data?.transactionHash) {
                                    this.log(`üì§ TX: ${status.data.transactionHash}`);
                                }
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Approval successful! Block: ${status.data.blockNumber}`, 'success');
                            
                            // Refresh approval status
                            await this.checkApproval();
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                            
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`Approval failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.approveBtn.disabled = false;
                    this.approveBtn.textContent = 'Approve Collateral';
                }
            }
            
            async executeFutarchyOperation(operation, args, buttonEl, progressSteps = [20, 40, 60, 80, 100]) {
                if (!this.isConnected) return;
                
                try {
                    const originalText = buttonEl.textContent;
                    buttonEl.disabled = true;
                    buttonEl.textContent = 'Processing...';
                    
                    this.updateProgress(progressSteps[0]);
                    this.log(`üîÑ Starting ${operation}...`);
                    
                    const hash = await this.walletClient.writeContract({
                        address: CONTRACTS.FUTARCHY_ROUTER,
                        abi: FUTARCHY_ABI,
                        functionName: operation,
                        args: args,
                        account: this.account
                    });
                    
                    this.updateProgress(progressSteps[3]);
                    this.log(`üì§ Transaction submitted: ${hash}`);
                    
                    const receipt = await this.publicClient.waitForTransactionReceipt({ hash });
                    
                    this.updateProgress(progressSteps[4]);
                    this.log(`üéâ ${operation} successful! Block: ${receipt.blockNumber}`, 'success');
                    
                    setTimeout(() => this.updateProgress(0), 2000);
                    
                } catch (error) {
                    this.log(`${operation} failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    buttonEl.disabled = false;
                    buttonEl.textContent = originalText;
                }
            }
            
            async splitPosition() {
                if (!this.isConnected) return;
                
                try {
                    this.splitBtn.disabled = true;
                    const originalText = this.splitBtn.textContent;
                    this.splitBtn.textContent = 'Splitting...';
                    this.updateProgress(20);
                    
                    const proposal = this.proposalAddress.value;
                    const collateralToken = this.collateralToken.value;
                    const amount = this.operationAmount.value;
                    
                    this.log(`üîÄ Splitting ${amount} tokens via DataLayer...`);
                    
                    // Use our DataLayer ‚Üí FutarchyCartridge system
                    for await (const status of this.dataLayer.execute('futarchy.splitPosition', {
                        proposal: proposal,
                        collateralToken: collateralToken,
                        amount: amount
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            if (status.step === 'prepare') {
                                this.updateProgress(40);
                            } else if (status.step === 'split') {
                                this.updateProgress(60);
                            } else if (status.step === 'confirm') {
                                this.updateProgress(80);
                                if (status.data?.transactionHash) {
                                    this.log(`üì§ TX: ${status.data.transactionHash}`);
                                }
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Position split successful! Block: ${status.data.blockNumber}`, 'success');
                            this.log(`‚ö° Gas used: ${status.data.gasUsed}`, 'success');
                            
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                            
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`Split position failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.splitBtn.disabled = false;
                    this.splitBtn.textContent = 'Split Position';
                }
            }
            
            // Toggle merge configuration section
            toggleMergeConfig() {
                const isVisible = this.mergeConfig.style.display !== 'none';
                
                if (isVisible) {
                    this.mergeConfig.style.display = 'none';
                    this.mergeBtn.textContent = 'Merge Positions';
                } else {
                    this.mergeConfig.style.display = 'block';
                    this.mergeBtn.textContent = 'Hide Merge Config';
                    
                    // Enable merge-related buttons when connected
                    if (this.isConnected) {
                        this.approveYesBtn.disabled = false;
                        this.approveNoBtn.disabled = false;
                        this.checkMergeApprovalsBtn.disabled = false;
                        this.executeMergeBtn.disabled = false;
                    }
                    
                    this.log('üîÄ Merge configuration opened - check approvals and set amount');
                }
            }
            
            // Check approvals for both YES and NO tokens
            async checkMergeApprovals() {
                if (!this.isConnected) return;
                
                this.log('üîç Checking YES and NO token approvals...');
                
                try {
                    // Check YES token approval
                    this.yesApprovalStatus.textContent = 'üîÑ Checking...';
                    
                    for await (const status of this.dataLayer.execute('futarchy.checkApproval', {
                        collateralToken: CONTRACTS.YES_TOKEN
                    })) {
                        if (status.status === 'success') {
                            const { isApproved, balanceFormatted, allowanceFormatted } = status.data;
                            this.yesApprovalStatus.textContent = isApproved ? `‚úÖ ${allowanceFormatted}` : '‚ùå Not approved';
                            this.yesApprovalStatus.className = `approval-status ${isApproved ? 'approved' : 'not-approved'}`;
                            this.log(`üìä YES balance: ${balanceFormatted}, approved: ${isApproved ? 'Yes' : 'No'}`);
                            break;
                        }
                    }
                    
                    // Check NO token approval
                    this.noApprovalStatus.textContent = 'üîÑ Checking...';
                    
                    for await (const status of this.dataLayer.execute('futarchy.checkApproval', {
                        collateralToken: CONTRACTS.NO_TOKEN
                    })) {
                        if (status.status === 'success') {
                            const { isApproved, balanceFormatted, allowanceFormatted } = status.data;
                            this.noApprovalStatus.textContent = isApproved ? `‚úÖ ${allowanceFormatted}` : '‚ùå Not approved';
                            this.noApprovalStatus.className = `approval-status ${isApproved ? 'approved' : 'not-approved'}`;
                            this.log(`üìä NO balance: ${balanceFormatted}, approved: ${isApproved ? 'Yes' : 'No'}`);
                            break;
                        }
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Approval check failed: ${error.message}`, 'error');
                }
            }
            
            // Approve YES token
            async approveYesToken() {
                if (!this.isConnected) return;
                
                try {
                    this.approveYesBtn.disabled = true;
                    this.approveYesBtn.textContent = 'Approving...';
                    
                    this.log('‚è≥ Approving YES token for Futarchy Router...');
                    
                    for await (const status of this.dataLayer.execute('futarchy.approveCollateral', {
                        collateralToken: CONTRACTS.YES_TOKEN,
                        amount: 'unlimited'
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'success') {
                            this.log('‚úÖ YES token approved!', 'success');
                            this.yesApprovalStatus.textContent = '‚úÖ Unlimited';
                            this.yesApprovalStatus.className = 'approval-status approved';
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`‚ùå YES approval failed: ${error.message}`, 'error');
                } finally {
                    this.approveYesBtn.disabled = false;
                    this.approveYesBtn.textContent = 'Approve YES';
                }
            }
            
            // Approve NO token
            async approveNoToken() {
                if (!this.isConnected) return;
                
                try {
                    this.approveNoBtn.disabled = true;
                    this.approveNoBtn.textContent = 'Approving...';
                    
                    this.log('‚è≥ Approving NO token for Futarchy Router...');
                    
                    for await (const status of this.dataLayer.execute('futarchy.approveCollateral', {
                        collateralToken: CONTRACTS.NO_TOKEN,
                        amount: 'unlimited'
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'success') {
                            this.log('‚úÖ NO token approved!', 'success');
                            this.noApprovalStatus.textContent = '‚úÖ Unlimited';
                            this.noApprovalStatus.className = 'approval-status approved';
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`‚ùå NO approval failed: ${error.message}`, 'error');
                } finally {
                    this.approveNoBtn.disabled = false;
                    this.approveNoBtn.textContent = 'Approve NO';
                }
            }
            
            // Execute merge positions  
            async executeMerge() {
                if (!this.isConnected) return;
                
                const amount = this.mergeAmount.value;
                this.log(`üîç Reading merge amount: "${amount}" from merge input field`);
                
                if (!amount || amount <= 0) {
                    this.log('‚ùå Please enter a valid merge amount in the merge configuration panel', 'error');
                    return;
                }
                
                try {
                    this.executeMergeBtn.disabled = true;
                    this.executeMergeBtn.textContent = 'Merging...';
                    this.updateProgress(20);
                    
                    this.log(`üîÄ Merging ${amount} YES+NO tokens back to collateral...`);
                    
                    // Use our DataLayer ‚Üí FutarchyCartridge system
                    for await (const status of this.dataLayer.execute('futarchy.mergePositions', {
                        proposal: CONTRACTS.REAL_PROPOSAL,
                        collateralToken: CONTRACTS.SDAI,
                        amount: amount
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            if (status.step === 'prepare') {
                                this.updateProgress(40);
                            } else if (status.step === 'merge') {
                                this.updateProgress(60);
                            } else if (status.step === 'confirm') {
                                this.updateProgress(80);
                                if (status.data?.transactionHash) {
                                    this.log(`üì§ TX: ${status.data.transactionHash}`);
                                }
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Positions merged successfully! Block: ${status.data.blockNumber}`, 'success');
                            this.log(`‚ö° Gas used: ${status.data.gasUsed}`, 'success');
                            
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                            
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`Merge positions failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.executeMergeBtn.disabled = false;
                    this.executeMergeBtn.textContent = 'üîÄ Execute Merge Transaction';
                }
            }
            
            async redeemPositions() {
                const args = [
                    this.proposalAddress.value,
                    this.collateralToken.value,
                    parseEther(this.operationAmount.value)
                ];
                await this.executeFutarchyOperation('redeemPositions', args, this.redeemPositionsBtn);
            }
            
            async redeemProposal() {
                const amount = parseEther(this.operationAmount.value);
                const args = [this.proposalAddress.value, amount, amount];
                await this.executeFutarchyOperation('redeemProposal', args, this.redeemProposalBtn);
            }
            
            async getWinningOutcomes() {
                if (!this.conditionId.value) {
                    this.log('‚ùå Please enter a condition ID', 'error');
                    return;
                }
                
                try {
                    this.getOutcomesBtn.disabled = true;
                    this.getOutcomesBtn.textContent = 'Fetching...';
                    
                    // This would use the futarchy router's getWinningOutcomes function
                    // For demo purposes, we'll simulate it
                    setTimeout(() => {
                        this.log(`üìä Winning outcomes for ${this.conditionId.value}: [true, false]`, 'success');
                        this.getOutcomesBtn.disabled = false;
                        this.getOutcomesBtn.textContent = 'Get Winning Outcomes';
                    }, 2000);
                    
                } catch (error) {
                    this.log(`Failed to get winning outcomes: ${error.message}`, 'error');
                    this.getOutcomesBtn.disabled = false;
                    this.getOutcomesBtn.textContent = 'Get Winning Outcomes';
                }
            }
            
            // Complete Split Operation - handles everything automatically
            async completeSplit() {
                if (!this.isConnected) return;
                
                const amount = this.operationAmount.value;
                if (!amount || amount <= 0) {
                    this.log('‚ùå Please enter a valid split amount', 'error');
                    return;
                }
                
                try {
                    this.completeSplitBtn.disabled = true;
                    this.completeSplitBtn.textContent = 'Processing...';
                    this.updateProgress(10);
                    
                    this.log(`‚ö° Starting complete split operation for ${amount} sDAI...`);
                    
                    // Use the FutarchyCartridge complete operation
                    for await (const status of this.dataLayer.execute('futarchy.completeSplit', {
                        proposal: CONTRACTS.REAL_PROPOSAL,
                        collateralToken: CONTRACTS.SDAI,
                        amount: amount
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            // Update progress based on step
                            if (status.step === 'check_approval') {
                                this.updateProgress(20);
                            } else if (status.step === 'approving' || status.step.includes('approve_')) {
                                this.updateProgress(50);
                            } else if (status.step === 'splitting' || status.step.includes('split_')) {
                                this.updateProgress(80);
                            }
                            
                            if (status.data?.transactionHash) {
                                this.log(`üì§ TX: ${status.data.transactionHash}`);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Complete split successful! Block: ${status.data.blockNumber}`, 'success');
                            this.log(`‚ö° Gas used: ${status.data.gasUsed}`, 'success');
                            
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Complete split failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.completeSplitBtn.disabled = false;
                    this.completeSplitBtn.textContent = '‚ö° Complete Split';
                }
            }
            
            // Complete Merge Operation - handles everything automatically
            async completeMerge() {
                if (!this.isConnected) return;
                
                // Always show merge config first to ensure user sets the amount
                if (this.mergeConfig.style.display === 'none') {
                    this.toggleMergeConfig();
                    this.log('üìù Merge config opened - please set merge amount and try again');
                    return;
                }
                
                const amount = this.mergeAmount.value;
                this.log(`üîç Reading merge amount: "${amount}" from merge input field`);
                
                if (!amount || amount <= 0) {
                    this.log('‚ùå Please enter a valid merge amount in the merge configuration panel', 'error');
                    return;
                }
                
                try {
                    this.completeMergeBtn.disabled = true;
                    this.completeMergeBtn.textContent = 'Processing...';
                    this.updateProgress(10);
                    
                    this.log(`‚ö° Starting complete merge operation for ${amount} YES+NO tokens...`);
                    
                    // Use the FutarchyCartridge complete operation
                    for await (const status of this.dataLayer.execute('futarchy.completeMerge', {
                        proposal: CONTRACTS.REAL_PROPOSAL,
                        collateralToken: CONTRACTS.SDAI,
                        amount: amount,
                        yesToken: CONTRACTS.YES_TOKEN,
                        noToken: CONTRACTS.NO_TOKEN
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            // Update progress based on step
                            if (status.step.includes('check_')) {
                                this.updateProgress(20);
                            } else if (status.step.includes('approving') || status.step.includes('approve_')) {
                                this.updateProgress(50);
                            } else if (status.step === 'merging' || status.step.includes('merge_')) {
                                this.updateProgress(80);
                            }
                            
                            if (status.data?.transactionHash) {
                                this.log(`üì§ TX: ${status.data.transactionHash}`);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Complete merge successful! Block: ${status.data.blockNumber}`, 'success');
                            this.log(`‚ö° Gas used: ${status.data.gasUsed}`, 'success');
                            
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Complete merge failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.completeMergeBtn.disabled = false;
                    this.completeMergeBtn.textContent = '‚ö° Complete Merge';
                }
            }
            
            // Complete Split + Swap Operation
            async completeSplitSwap() {
                if (!this.isConnected) return;
                
                const yesSdaiToken = this.yesSdaiToken.value.trim();
                const yesGnoToken = this.yesGnoToken.value.trim();
                const targetAmount = this.targetAmount.value;
                const slippageBps = this.swapSlippage.value || '100';
                
                // Validation
                if (!yesSdaiToken || !/^0x[a-fA-F0-9]{40}$/.test(yesSdaiToken)) {
                    this.log('‚ùå Please enter a valid YES SDAI token address', 'error');
                    return;
                }
                
                if (!yesGnoToken || !/^0x[a-fA-F0-9]{40}$/.test(yesGnoToken)) {
                    this.log('‚ùå Please enter a valid YES GNO token address', 'error');
                    return;
                }
                
                if (!targetAmount || targetAmount <= 0) {
                    this.log('‚ùå Please enter a valid target amount', 'error');
                    return;
                }
                
                if (yesSdaiToken === yesGnoToken) {
                    this.log('‚ùå YES SDAI and YES GNO token addresses must be different', 'error');
                    return;
                }
                
                try {
                    this.completeSplitSwapBtn.disabled = true;
                    this.completeSplitSwapBtn.textContent = 'Processing...';
                    this.updateProgress(10);
                    
                    this.log(`‚ö° Starting complete split + swap operation for ${targetAmount} YES SDAI ‚Üí YES GNO...`);
                    this.log(`üìã YES SDAI: ${yesSdaiToken}`);
                    this.log(`üìã YES GNO: ${yesGnoToken}`);
                    this.log(`üìã Slippage: ${slippageBps} basis points`);
                    
                    // Use the FutarchyCartridge complete split + swap operation
                    for await (const status of this.dataLayer.execute('futarchy.completeSplitSwap', {
                        proposal: CONTRACTS.REAL_PROPOSAL,
                        collateralToken: CONTRACTS.SDAI,
                        yesSdaiToken: yesSdaiToken,
                        yesGnoToken: yesGnoToken,
                        targetAmount: targetAmount,
                        slippageBps: slippageBps
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            // Update progress based on step
                            if (status.step === 'check_yes_balance' || status.step === 'check_sdai_balance') {
                                this.updateProgress(20);
                            } else if (status.step === 'calculating_split' || status.step === 'split_calculated') {
                                this.updateProgress(30);
                            } else if (status.step.includes('check_') && status.step.includes('approval')) {
                                this.updateProgress(40);
                            } else if (status.step.includes('approving') || status.step.includes('approve_')) {
                                this.updateProgress(50);
                            } else if (status.step === 'splitting' || status.step.includes('split_')) {
                                this.updateProgress(70);
                            } else if (status.step === 'swapping' || status.step.includes('swap_')) {
                                this.updateProgress(90);
                            }
                            
                            if (status.data?.transactionHash) {
                                this.log(`üì§ TX: ${status.data.transactionHash}`);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Complete split + swap successful!`, 'success');
                            
                            if (status.data?.transactionHash) {
                                this.log(`üìÑ Final TX: ${status.data.transactionHash}`, 'success');
                            }
                            if (status.data?.blockNumber) {
                                this.log(`üìä Block: ${status.data.blockNumber}`, 'success');
                            }
                            if (status.data?.gasUsed) {
                                this.log(`‚ö° Gas used: ${status.data.gasUsed}`, 'success');
                            }
                            
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Complete split + swap failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.completeSplitSwapBtn.disabled = false;
                    this.completeSplitSwapBtn.textContent = '‚ö° Complete Split + Swap';
                }
            }
            
            // Complete Redeem Outcomes Operation
            async completeRedeemOutcomes() {
                if (!this.isConnected) return;
                
                const token1Address = this.redeemToken1Address.value.trim();
                const token2Address = this.redeemToken2Address.value.trim();
                const amount1 = this.redeemAmount1.value;
                const amount2 = this.redeemAmount2.value;
                
                // Convert to numbers for validation
                const amount1Num = Number(amount1 || '0');
                const amount2Num = Number(amount2 || '0');
                
                // Validation
                if (amount1Num === 0 && amount2Num === 0) {
                    this.log('‚ùå At least one amount must be greater than 0', 'error');
                    return;
                }
                
                if (amount1Num > 0 && (!token1Address || !/^0x[a-fA-F0-9]{40}$/.test(token1Address))) {
                    this.log('‚ùå Please enter a valid Token 1 address when Amount 1 > 0', 'error');
                    return;
                }
                
                if (amount2Num > 0 && (!token2Address || !/^0x[a-fA-F0-9]{40}$/.test(token2Address))) {
                    this.log('‚ùå Please enter a valid Token 2 address when Amount 2 > 0', 'error');
                    return;
                }
                
                try {
                    this.completeRedeemOutcomesBtn.disabled = true;
                    this.completeRedeemOutcomesBtn.textContent = 'Processing...';
                    this.updateProgress(10);
                    
                    this.log(`üéØ Starting complete redeem outcomes operation...`);
                    this.log(`üìã Token 1: ${amount1Num > 0 ? token1Address : 'N/A'} (Amount: ${amount1})`);
                    this.log(`üìã Token 2: ${amount2Num > 0 ? token2Address : 'N/A'} (Amount: ${amount2})`);
                    
                    // Use the FutarchyCartridge complete redeem outcomes operation
                    for await (const status of this.dataLayer.execute('futarchy.completeRedeemOutcomes', {
                        proposal: CONTRACTS.REAL_PROPOSAL,
                        token1Address: amount1Num > 0 ? token1Address : null,
                        token2Address: amount2Num > 0 ? token2Address : null,
                        amount1: amount1,
                        amount2: amount2
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            // Update progress based on step
                            if (status.step.includes('check_') && status.step.includes('balance')) {
                                this.updateProgress(20);
                            } else if (status.step === 'balances_checked') {
                                this.updateProgress(30);
                            } else if (status.step.includes('check_') && status.step.includes('approval')) {
                                this.updateProgress(40);
                            } else if (status.step.includes('approving_')) {
                                this.updateProgress(60);
                            } else if (status.step === 'tokens_approved') {
                                this.updateProgress(70);
                            } else if (status.step === 'redeeming') {
                                this.updateProgress(90);
                            }
                            
                            if (status.data?.transactionHash) {
                                this.log(`üì§ TX: ${status.data.transactionHash}`);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Complete redeem outcomes successful!`, 'success');
                            
                            if (status.data?.transactionHash) {
                                this.log(`üìÑ TX: ${status.data.transactionHash}`, 'success');
                            }
                            if (status.data?.blockNumber) {
                                this.log(`üìä Block: ${status.data.blockNumber}`, 'success');
                            }
                            if (status.data?.gasUsed) {
                                this.log(`‚ö° Gas used: ${status.data.gasUsed}`, 'success');
                            }
                            if (status.data?.amount1 || status.data?.amount2) {
                                this.log(`üí∞ Redeemed: ${status.data.amount1} | ${status.data.amount2}`, 'success');
                            }
                            
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Complete redeem outcomes failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.completeRedeemOutcomesBtn.disabled = false;
                    this.completeRedeemOutcomesBtn.textContent = 'üéØ Complete Redeem Outcomes';
                }
            }
            
            // =============================================================================
            // FUTARCHY FETCHER OPERATIONS
            // =============================================================================
            
            async startFetcher() {
                if (this.fetcherRunning) {
                    this.log('‚ö†Ô∏è Fetcher is already running', 'error');
                    return;
                }
                
                this.fetcherRunning = true;
                this.startFetcherBtn.disabled = true;
                this.stopFetcherBtn.disabled = false;
                
                this.updateFetcherStatus('üîÑ Starting fetcher...');
                this.log('‚ñ∂Ô∏è Starting futarchy data fetcher (10s intervals)');
                
                // Initial fetch
                await this.fetchFutarchyData();
                
                // Set up interval
                this.fetcherInterval = setInterval(async () => {
                    await this.fetchFutarchyData();
                }, 10000); // 10 seconds
                
                this.updateFetcherStatus('üü¢ Running (10s intervals)');
            }
            
            stopFetcher() {
                if (!this.fetcherRunning) {
                    this.log('‚ö†Ô∏è Fetcher is not running', 'error');
                    return;
                }
                
                this.fetcherRunning = false;
                this.startFetcherBtn.disabled = false;
                this.stopFetcherBtn.disabled = true;
                
                if (this.fetcherInterval) {
                    clearInterval(this.fetcherInterval);
                    this.fetcherInterval = null;
                }
                
                this.updateFetcherStatus('‚è∏Ô∏è Stopped');
                this.log('‚è∏Ô∏è Futarchy data fetcher stopped');
            }
            
            async fetchOnce() {
                if (this.fetcherRunning) {
                    this.log('‚ö†Ô∏è Stop the running fetcher first', 'error');
                    return;
                }
                
                this.updateFetcherStatus('üîÑ Fetching...');
                this.log('üîÑ Fetching futarchy data once...');
                
                await this.fetchFutarchyData();
                
                this.updateFetcherStatus('‚úÖ Single fetch completed');
            }
            
            async fetchFutarchyData() {
                try {
                    const proposalAddress = CONTRACTS.REAL_PROPOSAL;
                    const userAddress = this.account;
                    
                    // Fetch complete data
                    const result = await this.dataLayer.fetch('futarchy.complete', {
                        proposalAddress,
                        userAddress
                    });
                    
                    if (result.status === 'success') {
                        this.updateFutarchyUI(result.data);
                        const timestamp = new Date().toLocaleTimeString();
                        this.updateFetcherStatus(`‚úÖ Last updated: ${timestamp}`);
                    } else {
                        console.error('Fetch failed:', result);
                        this.updateFetcherStatus(`‚ùå Error: ${result.reason}`);
                        this.log(`‚ùå Fetcher error: ${result.reason}`, 'error');
                    }
                    
                } catch (error) {
                    console.error('Fetch error:', error);
                    this.updateFetcherStatus(`‚ùå Error: ${error.message}`);
                    this.log(`‚ùå Fetcher error: ${error.message}`, 'error');
                }
            }
            
            updateFetcherStatus(status) {
                this.fetcherStatus.textContent = `Status: ${status}`;
            }
            
            updateFutarchyUI(data) {
                if (!data) return;
                
                // Show the data display
                this.futarchyDataDisplay.style.display = 'block';
                
                // Update proposal info
                if (data.proposal) {
                    const { marketName, proposalAddress, collateralTokens, outcomeTokens } = data.proposal;
                    
                    this.marketName.textContent = marketName || 'Unknown Market';
                    this.proposalAddressDisplay.textContent = `${proposalAddress.slice(0, 6)}...${proposalAddress.slice(-4)}`;
                    
                    // Update token addresses
                    this.companyToken.textContent = `${collateralTokens.company.slice(0, 6)}...${collateralTokens.company.slice(-4)}`;
                    this.currencyToken.textContent = `${collateralTokens.currency.slice(0, 6)}...${collateralTokens.currency.slice(-4)}`;
                    this.yesCompanyToken.textContent = `${outcomeTokens.yesCompany.slice(0, 6)}...${outcomeTokens.yesCompany.slice(-4)}`;
                    this.yesCurrencyToken.textContent = `${outcomeTokens.yesCurrency.slice(0, 6)}...${outcomeTokens.yesCurrency.slice(-4)}`;
                    this.noCompanyToken.textContent = `${outcomeTokens.noCompany.slice(0, 6)}...${outcomeTokens.noCompany.slice(-4)}`;
                    this.noCurrencyToken.textContent = `${outcomeTokens.noCurrency.slice(0, 6)}...${outcomeTokens.noCurrency.slice(-4)}`;
                }
                
                // Update user balances
                if (data.balances) {
                    this.userBalances.style.display = 'block';
                    
                    const { outcomeTokens, collateralTokens } = data.balances;
                    this.balanceYesCompany.textContent = parseFloat(outcomeTokens.yesCompany.formatted).toFixed(4);
                    this.balanceNoCompany.textContent = parseFloat(outcomeTokens.noCompany.formatted).toFixed(4);
                    this.balanceYesCurrency.textContent = parseFloat(outcomeTokens.yesCurrency.formatted).toFixed(4);
                    this.balanceNoCurrency.textContent = parseFloat(outcomeTokens.noCurrency.formatted).toFixed(4);
                    this.balanceCompany.textContent = parseFloat(collateralTokens.company.formatted).toFixed(4);
                    this.balanceCurrency.textContent = parseFloat(collateralTokens.currency.formatted).toFixed(4);
                } else {
                    this.userBalances.style.display = 'none';
                }
                
                // Update position analysis
                if (data.positions) {
                    this.positionAnalysis.style.display = 'block';
                    
                    const { mergeable, positions } = data.positions;
                    this.mergeableCompany.textContent = parseFloat(mergeable.company.formatted).toFixed(4);
                    this.mergeableCurrency.textContent = parseFloat(mergeable.currency.formatted).toFixed(4);
                    this.positionCompany.textContent = positions.company.description;
                    this.positionCurrency.textContent = positions.currency.description;
                } else {
                    this.positionAnalysis.style.display = 'none';
                }
            }
            
            // =============================================================================
            // MARKET DISCOVERY OPERATIONS
            // =============================================================================
            
            async discoverMarkets() {
                if (!this.hasMarketDiscovery) {
                    this.log('‚ö†Ô∏è Market discovery not available - Supabase not configured', 'error');
                    return;
                }
                
                this.updateMarketDiscoveryStatus('üîç Discovering markets...');
                this.log('üîç Discovering all available markets...');
                
                try {
                    const result = await this.dataLayer.fetch('markets.events', { 
                        limit: 50 
                    });
                    
                    if (result.status === 'success') {
                        this.currentMarkets = result.data;
                        this.displayMarkets(this.currentMarkets);
                        this.updateMarketDiscoveryStatus(`‚úÖ Found ${result.count} markets`);
                        this.log(`‚úÖ Discovered ${result.count} markets`);
                    } else {
                        this.updateMarketDiscoveryStatus(`‚ùå Error: ${result.reason}`);
                        this.log(`‚ùå Discovery failed: ${result.reason}`, 'error');
                    }
                    
                } catch (error) {
                    this.updateMarketDiscoveryStatus(`‚ùå Error: ${error.message}`);
                    this.log(`‚ùå Discovery error: ${error.message}`, 'error');
                }
            }
            
            async filterMarkets(filter) {
                if (!this.hasMarketDiscovery) {
                    this.log('‚ö†Ô∏è Market discovery not available', 'error');
                    return;
                }
                
                let filterParams = { limit: 50 };
                let filterText = '';
                
                if (filter === 'open') {
                    filterParams.status = 'open';
                    filterText = 'open ';
                } else if (filter === 'public') {
                    filterParams.visibility = 'public';
                    filterText = 'public ';
                }
                
                this.updateMarketDiscoveryStatus(`üîç Finding ${filterText}markets...`);
                this.log(`üîç Filtering for ${filterText}markets...`);
                
                try {
                    const result = await this.dataLayer.fetch('markets.events', filterParams);
                    
                    if (result.status === 'success') {
                        this.currentMarkets = result.data;
                        this.displayMarkets(this.currentMarkets);
                        this.updateMarketDiscoveryStatus(`‚úÖ Found ${result.count} ${filterText}markets`);
                        this.log(`‚úÖ Found ${result.count} ${filterText}markets`);
                    } else {
                        this.updateMarketDiscoveryStatus(`‚ùå Error: ${result.reason}`);
                        this.log(`‚ùå Filter failed: ${result.reason}`, 'error');
                    }
                    
                } catch (error) {
                    this.updateMarketDiscoveryStatus(`‚ùå Error: ${error.message}`);
                    this.log(`‚ùå Filter error: ${error.message}`, 'error');
                }
            }
            
            async refreshMarkets() {
                this.log('üîÑ Refreshing markets...');
                await this.discoverMarkets();
            }
            
            updateMarketDiscoveryStatus(status) {
                this.marketDiscoveryStatus.textContent = `Status: ${status}`;
            }
            
            displayMarkets(markets) {
                // Show the markets list
                this.marketsList.style.display = 'block';
                
                // Clear existing markets
                this.marketsContainer.innerHTML = '';
                
                if (!markets || markets.length === 0) {
                    this.marketsContainer.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No markets found</div>';
                    return;
                }
                
                // Create market cards
                markets.forEach((market, index) => {
                    const marketCard = document.createElement('div');
                    marketCard.className = 'market-card';
                    marketCard.style.cssText = `
                        padding: 1rem;
                        margin: 0.5rem;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        background: white;
                    `;
                    
                    // Determine status styling
                    const statusColor = market.summary.isResolved ? '#4caf50' : 
                                       market.summary.isOpen ? '#2196f3' : '#ff9800';
                    const statusText = market.summary.isResolved ? 
                                      `Resolved (${market.summary.outcome})` :
                                      market.summary.isOpen ? 'Open' : 'Pending';
                    
                    marketCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <div style="font-weight: bold; color: #333; flex: 1; margin-right: 1rem;">
                                ${market.title}
                            </div>
                            <div style="background: ${statusColor}; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; white-space: nowrap;">
                                ${statusText}
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                            üìç ID: ${market.id.slice(0, 8)}...${market.id.slice(-6)}
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                            üí∞ Tokens: ${market.tokens} | üëÅÔ∏è ${market.visibility} | üìÖ ${new Date(market.end_date).toLocaleDateString()}
                        </div>
                        ${market.tokenAddresses ? `
                            <div style="font-size: 0.7rem; color: #999; font-family: Monaco, monospace;">
                                Proposal: ${market.tokenAddresses.proposalAddress.slice(0, 8)}...${market.tokenAddresses.proposalAddress.slice(-6)}
                            </div>
                        ` : ''}
                    `;
                    
                    // Add hover effects
                    marketCard.addEventListener('mouseenter', () => {
                        marketCard.style.background = '#f5f5f5';
                        marketCard.style.borderColor = '#1976d2';
                        marketCard.style.transform = 'translateY(-2px)';
                        marketCard.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                    });
                    
                    marketCard.addEventListener('mouseleave', () => {
                        marketCard.style.background = 'white';
                        marketCard.style.borderColor = '#ddd';
                        marketCard.style.transform = 'translateY(0)';
                        marketCard.style.boxShadow = 'none';
                    });
                    
                    // Add click handler to select market
                    marketCard.addEventListener('click', () => {
                        this.selectMarket(market);
                    });
                    
                    this.marketsContainer.appendChild(marketCard);
                });
            }
            
            selectMarket(market) {
                this.log(`üéØ Selected market: ${market.title}`);
                
                // Auto-populate proposal address in forms
                if (market.tokenAddresses && market.tokenAddresses.proposalAddress) {
                    const proposalAddress = market.tokenAddresses.proposalAddress;
                    
                    // Update the proposal address input (if it exists)
                    const proposalInput = document.getElementById('proposal-address');
                    if (proposalInput) {
                        proposalInput.value = proposalAddress;
                    }
                    
                    // Update any other forms that might use proposal address
                    const allProposalInputs = document.querySelectorAll('input[placeholder*="proposal"], input[placeholder*="Proposal"]');
                    allProposalInputs.forEach(input => {
                        input.value = proposalAddress;
                    });
                    
                    // Auto-populate redeem form if this is a resolved market
                    if (market.summary.isResolved && market.tokenAddresses) {
                        const token1Input = document.getElementById('redeem-token1-address');
                        const token2Input = document.getElementById('redeem-token2-address');
                        
                        if (token1Input && token2Input) {
                            // For resolved markets, set the winning outcome tokens
                            if (market.summary.outcome === 'yes') {
                                token1Input.value = market.tokenAddresses.yesCompany || '';
                                token2Input.value = market.tokenAddresses.yesCurrency || '';
                            } else if (market.summary.outcome === 'no') {
                                token1Input.value = market.tokenAddresses.noCompany || '';
                                token2Input.value = market.tokenAddresses.noCurrency || '';
                            }
                        }
                    }
                    
                    // Auto-populate split+swap form
                    const yesSdaiInput = document.getElementById('yes-sdai-token');
                    const yesGnoInput = document.getElementById('yes-gno-token');
                    
                    if (yesSdaiInput && market.tokenAddresses.yesCurrency) {
                        yesSdaiInput.value = market.tokenAddresses.yesCurrency;
                    }
                    if (yesGnoInput && market.tokenAddresses.yesCompany) {
                        yesGnoInput.value = market.tokenAddresses.yesCompany;
                    }
                    
                    // If fetcher is not running, start it for this market
                    if (!this.fetcherRunning && this.account) {
                        // Update the fetcher to use this proposal address
                        CONTRACTS.REAL_PROPOSAL = proposalAddress;
                        this.log(`üìä Updated target proposal to: ${proposalAddress.slice(0, 8)}...`);
                    }
                    
                    this.log('‚úÖ Market data populated into forms');
                    this.log(`üí° Tip: Use "Start Fetcher" to see live data for this market`);
                }
            }
            
            // =============================================================================
            // COW SWAP OPERATIONS
            // =============================================================================
            
            async cowCheckApproval() {
                if (!this.isConnected) return;
                
                try {
                    this.cowCheckApprovalBtn.disabled = true;
                    this.cowCheckApprovalBtn.textContent = 'Checking...';
                    
                    this.log('üîç Checking sDAI approval for CoW Protocol...');
                    
                    for await (const status of this.dataLayer.execute('cowswap.checkApproval', {
                        tokenAddress: CONTRACTS.SDAI
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'success') {
                            const { isApproved, allowanceFormatted, balanceFormatted } = status.data;
                            this.log(`üìä CoW Protocol - Approved: ${isApproved ? 'Yes' : 'No'}, Balance: ${balanceFormatted}`, 'success');
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                } catch (error) {
                    this.log(`CoW approval check failed: ${error.message}`, 'error');
                } finally {
                    this.cowCheckApprovalBtn.disabled = false;
                    this.cowCheckApprovalBtn.textContent = 'Check Approval';
                }
            }
            
            async cowApprove() {
                if (!this.isConnected) return;
                
                try {
                    this.cowApproveBtn.disabled = true;
                    this.cowApproveBtn.textContent = 'Approving...';
                    this.updateProgress(20);
                    
                    this.log('‚è≥ Approving sDAI for CoW Protocol...');
                    
                    for await (const status of this.dataLayer.execute('cowswap.approve', {
                        tokenAddress: CONTRACTS.SDAI,
                        amount: 'unlimited'
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending' && status.step === 'confirm') {
                            this.updateProgress(60);
                            if (status.data?.transactionHash) {
                                this.log(`üì§ TX: ${status.data.transactionHash}`);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`‚úÖ CoW Protocol approval successful! Block: ${status.data.blockNumber}`, 'success');
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                } catch (error) {
                    this.log(`CoW approval failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.cowApproveBtn.disabled = false;
                    this.cowApproveBtn.textContent = 'Approve sDAI';
                }
            }
            
            async cowSwap() {
                if (!this.isConnected) return;
                
                const amount = this.swapAmount.value;
                if (!amount || amount <= 0) {
                    this.log('‚ùå Please enter a valid swap amount', 'error');
                    return;
                }
                
                try {
                    this.cowSwapBtn.disabled = true;
                    this.cowSwapBtn.textContent = 'Swapping...';
                    this.updateProgress(20);
                    
                    this.log(`üêÑ Swapping ${amount} sDAI ‚Üí wxDAI via CoW Protocol...`);
                    
                    for await (const status of this.dataLayer.execute('cowswap.swap', {
                        sellToken: CONTRACTS.SDAI,
                        buyToken: CONTRACTS.WXDAI,
                        amount: amount
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            if (status.step === 'quote') {
                                this.updateProgress(40);
                            } else if (status.step === 'sign' || status.step === 'signing') {
                                this.updateProgress(60);
                            } else if (status.step === 'submit') {
                                this.updateProgress(80);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ CoW swap order submitted! Order ID: ${status.data.orderId}`, 'success');
                            this.log(`üí± Expected: ${status.data.sellTokenFormatted} ‚Üí ${status.data.buyTokenEstimated}`, 'success');
                            
                            // Show CoW Explorer link
                            if (status.data.cowExplorerLink) {
                                this.log(`üîó View order: ${status.data.cowExplorerLink}`, 'success');
                            }
                            
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                } catch (error) {
                    this.log(`CoW swap failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.cowSwapBtn.disabled = false;
                    this.cowSwapBtn.textContent = 'Swap via CoW';
                }
            }
            
            async cowCompleteSwap() {
                if (!this.isConnected) return;
                
                const amount = this.swapAmount.value;
                if (!amount || amount <= 0) {
                    this.log('‚ùå Please enter a valid swap amount', 'error');
                    return;
                }
                
                try {
                    this.cowCompleteSwapBtn.disabled = true;
                    this.cowCompleteSwapBtn.textContent = 'Processing...';
                    this.updateProgress(10);
                    
                    this.log(`‚ö° Starting complete CoW swap for ${amount} sDAI ‚Üí wxDAI...`);
                    
                    for await (const status of this.dataLayer.execute('cowswap.completeSwap', {
                        sellToken: CONTRACTS.SDAI,
                        buyToken: CONTRACTS.WXDAI,
                        amount: amount
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            if (status.step.includes('check_')) {
                                this.updateProgress(20);
                            } else if (status.step.includes('approv')) {
                                this.updateProgress(50);
                            } else if (status.step.includes('swap')) {
                                this.updateProgress(80);
                            }
                            
                            if (status.data?.transactionHash || status.data?.orderId) {
                                this.log(`üì§ TX/Order: ${status.data.transactionHash || status.data.orderId}`);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Complete CoW swap successful!`, 'success');
                            if (status.data?.orderId) {
                                this.log(`üÜî Order ID: ${status.data.orderId}`, 'success');
                            }
                            
                            // Show CoW Explorer link
                            if (status.data?.cowExplorerLink) {
                                this.log(`üîó View order: ${status.data.cowExplorerLink}`, 'success');
                            }
                            
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                } catch (error) {
                    this.log(`Complete CoW swap failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.cowCompleteSwapBtn.disabled = false;
                    this.cowCompleteSwapBtn.textContent = '‚ö° Complete CoW Swap';
                }
            }
            
            // =============================================================================
            // SWAPR ALGEBRA OPERATIONS
            // =============================================================================
            
            async swaprCheckApproval() {
                if (!this.isConnected) return;
                
                try {
                    this.swaprCheckApprovalBtn.disabled = true;
                    this.swaprCheckApprovalBtn.textContent = 'Checking...';
                    
                    this.log('üîç Checking sDAI approval for Swapr V3 Router...');
                    
                    for await (const status of this.dataLayer.execute('swapr.checkApproval', {
                        tokenAddress: CONTRACTS.SDAI
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'success') {
                            const { isApproved, allowanceFormatted, balanceFormatted } = status.data;
                            this.log(`üìä Swapr V3 - Approved: ${isApproved ? 'Yes' : 'No'}, Balance: ${balanceFormatted}`, 'success');
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                } catch (error) {
                    this.log(`Swapr approval check failed: ${error.message}`, 'error');
                } finally {
                    this.swaprCheckApprovalBtn.disabled = false;
                    this.swaprCheckApprovalBtn.textContent = 'Check Approval';
                }
            }
            
            async swaprApprove() {
                if (!this.isConnected) return;
                
                try {
                    this.swaprApproveBtn.disabled = true;
                    this.swaprApproveBtn.textContent = 'Approving...';
                    this.updateProgress(20);
                    
                    this.log('‚è≥ Approving sDAI for Swapr V3 Router...');
                    
                    for await (const status of this.dataLayer.execute('swapr.approve', {
                        tokenAddress: CONTRACTS.SDAI,
                        amount: 'unlimited'
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending' && status.step === 'confirm') {
                            this.updateProgress(60);
                            if (status.data?.transactionHash) {
                                this.log(`üì§ TX: ${status.data.transactionHash}`);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`‚úÖ Swapr V3 approval successful! Block: ${status.data.blockNumber}`, 'success');
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                } catch (error) {
                    this.log(`Swapr approval failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.swaprApproveBtn.disabled = false;
                    this.swaprApproveBtn.textContent = 'Approve sDAI';
                }
            }
            
            async swaprSwap() {
                if (!this.isConnected) return;
                
                const amount = this.swapAmount.value;
                if (!amount || amount <= 0) {
                    this.log('‚ùå Please enter a valid swap amount', 'error');
                    return;
                }
                
                try {
                    this.swaprSwapBtn.disabled = true;
                    this.swaprSwapBtn.textContent = 'Swapping...';
                    this.updateProgress(20);
                    
                    this.log(`üîÑ Swapping ${amount} sDAI ‚Üí wxDAI via Swapr V3 Algebra...`);
                    
                    for await (const status of this.dataLayer.execute('swapr.swap', {
                        tokenIn: CONTRACTS.SDAI,
                        tokenOut: CONTRACTS.WXDAI,
                        amount: amount,
                        slippageBps: 0 // No slippage protection as requested
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            if (status.step === 'quote') {
                                this.updateProgress(40);
                            } else if (status.step === 'execute') {
                                this.updateProgress(60);
                            } else if (status.step === 'confirm') {
                                this.updateProgress(80);
                                if (status.data?.transactionHash) {
                                    this.log(`üì§ TX: ${status.data.transactionHash}`);
                                }
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Swapr V3 swap successful! Block: ${status.data.blockNumber}`, 'success');
                            this.log(`‚ö° Gas used: ${status.data.gasUsed}`, 'success');
                            this.log(`üí± Swapped: ${status.data.tokenInFormatted} sDAI`, 'success');
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                } catch (error) {
                    this.log(`Swapr swap failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.swaprSwapBtn.disabled = false;
                    this.swaprSwapBtn.textContent = 'Swap via Swapr';
                }
            }
            
            async swaprCompleteSwap() {
                if (!this.isConnected) return;
                
                const amount = this.swapAmount.value;
                if (!amount || amount <= 0) {
                    this.log('‚ùå Please enter a valid swap amount', 'error');
                    return;
                }
                
                try {
                    this.swaprCompleteSwapBtn.disabled = true;
                    this.swaprCompleteSwapBtn.textContent = 'Processing...';
                    this.updateProgress(10);
                    
                    this.log(`‚ö° Starting complete Swapr swap for ${amount} sDAI ‚Üí wxDAI...`);
                    
                    for await (const status of this.dataLayer.execute('swapr.completeSwap', {
                        tokenIn: CONTRACTS.SDAI,
                        tokenOut: CONTRACTS.WXDAI,
                        amount: amount,
                        slippageBps: 0 // No slippage protection as requested
                    })) {
                        this.log(`${status.status}: ${status.message}`);
                        
                        if (status.status === 'pending') {
                            if (status.step.includes('check_')) {
                                this.updateProgress(20);
                            } else if (status.step.includes('approv')) {
                                this.updateProgress(50);
                            } else if (status.step.includes('swap')) {
                                this.updateProgress(80);
                            }
                            
                            if (status.data?.transactionHash) {
                                this.log(`üì§ TX: ${status.data.transactionHash}`);
                            }
                        } else if (status.status === 'success') {
                            this.updateProgress(100);
                            this.log(`üéâ Complete Swapr swap successful! Block: ${status.data.blockNumber}`, 'success');
                            this.log(`‚ö° Gas used: ${status.data.gasUsed}`, 'success');
                            setTimeout(() => this.updateProgress(0), 2000);
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || status.message);
                        }
                    }
                } catch (error) {
                    this.log(`Complete Swapr swap failed: ${error.message}`, 'error');
                    this.updateProgress(0);
                } finally {
                    this.swaprCompleteSwapBtn.disabled = false;
                    this.swaprCompleteSwapBtn.textContent = '‚ö° Complete Swapr Swap';
                }
            }
        }

        // Initialize the demo
        document.addEventListener('DOMContentLoaded', () => {
            window.futarchyDemo = new FutarchyDemo();
        });
    </script>
</body>
</html> 